generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int             @id @default(autoincrement())
  email            String?         @unique
  password         String?
  nombre           String
  apellido         String
  cedula           String          @unique
  fecha_nacimiento DateTime
  tipo_comercio    String
  foto_url         String?
  whatsapp         String          @unique
  role             Role            @default(deudor)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  fondo_acumulado  Float           @default(0)
  tienda_activa    Boolean         @default(false)
  tienda_nombre    String?
  tienda_slug      String?         @unique
  clientProducts   ClientProduct[]
  investments      Investment[]
  loans            Loan[]
  payments         Payment[]
  riskEvents       RiskEvent[]
  salesReports     SalesReport[]
}

model Loan {
  id                    Int           @id @default(autoincrement())
  userId                Int
  monto_principal       Float
  interes_total_percent Float
  total_a_devolver      Float
  plazo_dias            Int
  fecha_otorgado        DateTime
  fecha_inicio_cobro    DateTime
  estado                LoanStatus    @default(activo)
  riesgo_score          Float?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  monto_diario          Float
  installments          Installment[]
  user                  User          @relation(fields: [userId], references: [id])
}

model Installment {
  id             Int               @id @default(autoincrement())
  loanId         Int
  fecha          DateTime
  monto_expected Float
  monto_pagado   Float             @default(0)
  status         InstallmentStatus @default(pendiente)
  recibo_url     String?
  cobrador_id    Int?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  loan           Loan              @relation(fields: [loanId], references: [id])
  payments       Payment[]
}

model Payment {
  id              Int         @id @default(autoincrement())
  installmentId   Int
  userId          Int
  monto           Float
  comprobante_url String?
  confirmado      Boolean     @default(false)
  confirmado_por  Int?
  comentario      String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  installment     Installment @relation(fields: [installmentId], references: [id])
  user            User        @relation(fields: [userId], references: [id])
}

model RiskEvent {
  id           Int      @id @default(autoincrement())
  userId       Int
  evento       String
  score_impact Float
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])
}

model Product {
  id                    Int          @id @default(autoincrement())
  nombre                String
  descripcion           String?
  categoria             String
  precio_compra         Float
  precio_venta_sugerido Float
  unidad                String
  cantidad_por_unidad   Float
  imagen_url            String?
  stock_disponible      Float        @default(0)
  activo                Boolean      @default(true)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  investments           Investment[]
}

model Investment {
  id                     Int              @id @default(autoincrement())
  userId                 Int
  productId              Int
  cantidad_comprada      Float
  precio_unitario        Float
  monto_total            Float
  fecha_compra           DateTime         @default(now())
  estado                 InvestmentStatus @default(activo)
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  fecha_limite_pago      DateTime?
  pagado                 Boolean          @default(true)
  tipo_pago              PaymentType      @default(inmediato)
  precio_reventa_cliente Float?
  product                Product          @relation(fields: [productId], references: [id])
  user                   User             @relation(fields: [userId], references: [id])
  salesReports           SalesReport[]
}

model SalesReport {
  id                Int        @id @default(autoincrement())
  userId            Int
  investmentId      Int
  cantidad_vendida  Float
  precio_venta      Float
  monto_total_venta Float
  ganancia_generada Float
  fecha_venta       DateTime
  comprobante_url   String?
  verificado        Boolean    @default(false)
  verificado_por    Int?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  investment        Investment @relation(fields: [investmentId], references: [id])
  user              User       @relation(fields: [userId], references: [id])
}

model ClientProduct {
  id          Int      @id @default(autoincrement())
  userId      Int
  nombre      String
  descripcion String?
  categoria   String
  precio      Float
  stock       Float    @default(0)
  imagen_url  String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])
}

enum Role {
  deudor
  cobrador
  admin
}

enum LoanStatus {
  activo
  finiquitado
  moroso
  cancelado
}

enum InstallmentStatus {
  pendiente
  pagado
  parcial
  vencido
}

enum InvestmentStatus {
  activo
  vendido_parcial
  vendido_completo
  cancelado
}

enum PaymentType {
  inmediato
  microcredito
}
