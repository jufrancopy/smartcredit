datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              Int      @id @default(autoincrement())
  email           String?   @unique
  password        String?
  nombre          String
  apellido        String
  cedula          String   @unique
  fecha_nacimiento DateTime
  tipo_comercio   String
  foto_url        String?
  whatsapp        String   @unique
  role            Role     @default(deudor)
  loans           Loan[]
  payments        Payment[]
  riskEvents      RiskEvent[]
  investments     Investment[]
  salesReports    SalesReport[]
  clientProducts  ClientProduct[]
  createdAt       DateTime @default(now())
  fondo_acumulado Float    @default(0)
  tienda_slug     String?  @unique
  tienda_nombre   String?
  tienda_activa   Boolean  @default(false)
  updatedAt       DateTime @updatedAt
}

model Loan {
  id                    Int           @id @default(autoincrement())
  user                  User          @relation(fields: [userId], references: [id])
  userId                Int
  monto_principal       Float
  interes_total_percent Float
  total_a_devolver      Float
  plazo_dias            Int
  monto_diario          Float // Nuevo campo para el monto diario a pagar
  fecha_otorgado        DateTime
  fecha_inicio_cobro    DateTime
  estado                LoanStatus    @default(activo)
  riesgo_score          Float?
  installments          Installment[]
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
}

model Installment {
  id            Int             @id @default(autoincrement())
  loan          Loan            @relation(fields: [loanId], references: [id])
  loanId        Int
  fecha         DateTime
  monto_expected Float
  monto_pagado  Float           @default(0)
  status        InstallmentStatus @default(pendiente)
  recibo_url    String?
  cobrador_id   Int?
  payments      Payment[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model Payment {
  id              Int         @id @default(autoincrement())
  installment     Installment @relation(fields: [installmentId], references: [id])
  installmentId   Int
  user            User        @relation(fields: [userId], references: [id])
  userId          Int
  monto           Float
  comprobante_url String?
  confirmado      Boolean     @default(false)
  confirmado_por  Int?
  comentario      String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model RiskEvent {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id])
  userId      Int
  evento      String
  score_impact Float
  createdAt   DateTime @default(now())
}

enum Role {
  deudor
  cobrador
  admin
}

enum LoanStatus {
  activo
  finiquitado
  moroso
  cancelado
}

enum InstallmentStatus {
  pendiente
  pagado
  parcial
  vencido
}

model Product {
  id                Int          @id @default(autoincrement())
  nombre            String
  descripcion       String?
  categoria         String
  precio_compra     Float        // Lo que paga SmartCredit
  precio_venta_sugerido Float    // Precio sugerido para el cliente
  unidad            String       // "caja", "maple", "kg", etc.
  cantidad_por_unidad Float      // Ej: 12 leches por caja, 1.0 para kg
  imagen_url        String?
  stock_disponible  Float        @default(0)
  activo            Boolean      @default(true)
  investments       Investment[]
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
}

model Investment {
  id                Int          @id @default(autoincrement())
  user              User         @relation(fields: [userId], references: [id])
  userId            Int
  product           Product      @relation(fields: [productId], references: [id])
  productId         Int
  cantidad_comprada Float        // Soporta decimales para kg, litros, etc.
  precio_unitario   Float        // Precio al momento de la compra
  precio_reventa_cliente Float?   // Precio personalizado del cliente para reventa
  monto_total       Float        // cantidad * precio_unitario
  monto_pagado      Float        @default(0) // Monto pagado parcialmente
  fecha_compra      DateTime     @default(now())
  estado            InvestmentStatus @default(activo)
  tipo_pago         PaymentType  @default(inmediato)
  fecha_limite_pago DateTime?    // Para microcréditos
  pagado            Boolean      @default(true)
  salesReports      SalesReport[]
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
}

model SalesReport {
  id                Int        @id @default(autoincrement())
  user              User       @relation(fields: [userId], references: [id])
  userId            Int
  investment        Investment @relation(fields: [investmentId], references: [id])
  investmentId      Int
  cantidad_vendida  Float      // Soporta decimales para kg, litros, etc.
  precio_venta      Float      // Precio al que vendió el cliente
  monto_total_venta Float      // cantidad * precio_venta
  ganancia_generada Float      // monto_total_venta - (cantidad * precio_compra_original)
  fecha_venta       DateTime
  comprobante_url   String?    // Foto del comprobante de venta
  verificado        Boolean    @default(false)
  verificado_por    Int?       // ID del admin que verificó
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

enum InvestmentStatus {
  activo
  vendido_parcial
  vendido_completo
  cancelado
}

enum PaymentType {
  inmediato
  microcredito
}

model ClientProduct {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id])
  userId      Int
  nombre      String
  descripcion String?
  categoria   String
  precio      Float
  stock       Float    @default(0)  // Soporta decimales para kg, litros, etc.
  imagen_url  String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
